HASKELL_BUILD_DIR := dist/build

all: cabal

machine :=$(shell uname -m)

# TODO: remove this once we change to Java instead of MEX
thrift_inc =/usr/local/include/thrift

thrift_build = src/thrift


ifeq (@CUDA_ENABLED@, true)

# Build haskell via 'make' to allow parallel build using the -j flag. This is
# passed on to the recursive make call. Cabal doesn't support building specific
# flags. Selecting targets is done via ./Setup.lhs configure.
cabal: src/Simulation/CUDA/KernelFFI.hsc $(thrift_build)/gen-hs
	@echo "Using configuration from previous run of ./Setup.lhs configure"
	@./Setup.lhs build


CUDA_INSTALL_PATH = @CUDA_PATH@
include cuda.mk

# TODO: use better names in cuda.mk, or hide them
CUDA_LIB := $(TARGET)

# Force cabal/ghc to relink if the kernel library changes
src/Simulation/CUDA/KernelFFI.hsc: $(CUDA_LIB)
	@touch $@

else

cabal: $(thrift_build)/gen-hs
	@echo "Using configuration from previous run of ./Setup.lhs configure"
	@./Setup.lhs build

endif

client: matlab-client

autogen := dist/build/autogen


matlab_src = src/ExternalClient/matlab
matlab_build = dist/build/matlab
matlab_m_files := $(basename $(basename $(notdir $(wildcard $(matlab_src)/*.m.m4))))

# Additional Matlab files, for use in reference implementation.
# (No preprocessing required.)
matlab_ref_utils := $(addprefix $(matlab_src)/util/,sparsify.m mergeDuplicates.m)


matlab-client: $(matlab_build)/nemo_mex.mexa64 \
		$(patsubst %,$(matlab_build)/%.m,$(matlab_m_files)) \
		matlab-reference

matlab-reference: $(patsubst %,$(matlab_build)/reference/%.m,$(matlab_m_files)) $(matlab_ref_utils)
	mkdir -p $(matlab_build)
	cp --target-directory $(matlab_build)/reference $(matlab_ref_utils)

# Generate LUT for Matlab API function dispatch
# (m4-macros for m-file or c++ function array)
.PRECIOUS: $(autogen)/mex_fn_lut.hpp
$(autogen)/mex_fn_lut.%: $(matlab_src)/gen_fn.py $(matlab_src)/*.m.m4
	mkdir -p $(dir $@)
	$< --$* $(matlab_m_files) > $@


# Generate Matlab files from source, documentation, and function LUT
$(matlab_build)/%.m: $(autogen)/mex_fn_lut.m4 $(matlab_src)/%.m.m4 $(matlab_src)/%.m.help
	$(matlab_src)/m-help $(word 3, $^) > $@
	m4 $(wordlist 1, 2, $^) >> $@


# Generate Matlab reference source files from source and documentation
$(matlab_build)/reference/%.m: $(matlab_src)/%.m.ref $(matlab_src)/%.m.help
	mkdir -p $(dir $@)
	$(matlab_src)/m-help $(word 2, $^) > $@
	cat $< >> $@


# TODO: detect the default extension for matlab-mex
# TODO: windows build
$(matlab_build)/%.mexa64: $(matlab_src)/%.cpp $(thrift_build)/gen-cpp $(autogen)/mex_fn_lut.hpp
	mkdir -p $(dir $@)
	matlab-mex -I$(thrift_inc) -I$(thrift_build)/gen-cpp -I$(autogen) -lthrift \
		-o $(matlab_build)/$* \
		$< $(addprefix $(thrift_build)/gen-cpp/,NemoFrontend.cpp nemo_types.cpp)


ifeq (@HAVE_THRIFT_COMPILER@, true)

.PRECIOUS: $(thrift_build)/gen-%
$(thrift_build)/gen-%: src/thrift/nemo.thrift
	@THRIFT@ --gen $* -o $(thrift_build) $<
	touch $@

else

$(thrift_build)/gen-%: src/thrift/nemo.thrift
	$(warning "Auto-generated thrift files out-of-date, but no thrift compiler available")

endif


# Target only needed for install
$(HASKELL_BUILD_DIR)/nemo-server/nemo-server: all


#
# Distribution
#

dist_dir := dist/build/nemo-$(machine)-@PACKAGE_VERSION@
doc_build := dist/build/manual

.PHONY: dist
dist: $(dist_dir).zip


# TODO: get architecture from system
# TODO: use proper dependencies here
$(dist_dir).zip: $(doc_build)/manual.pdf client cabal
	mkdir -p $(basename $@)
	cp --target-directory $(dist_dir) -r $< dist/build/nemo/nemo dist/build/matlab
	strip $(dist_dir)/nemo
	# include shared thrift libraries as well.
	(cd dist/build; zip -r $(notdir $@) $(basename $(notdir $@)); cd ../..)


#
# Documentation
#

doc_src := doc/manual

.PHONY: doc
doc: $(doc_build)/manual.pdf

.PHONY: doc-clean
doc-clean:
	rm -rf $(doc_build)

$(doc_build)/matlab.tex: $(matlab_src)/*.m.help
	cat $^ | util/matlab-manual-api.sh > $@

$(doc_build)/%.tex: $(doc_src)/%.tex
	mkdir -p $(dir $@)
	cp --target-directory=$(dir $@) $<

$(doc_build)/manual.pdf: $(doc_build)/manual.tex \
		$(doc_build)/title.tex \
		$(doc_build)/matlab.tex
	ln -s -f --target-directory=$(doc_build) $(CURDIR)/$(doc_src)/figures
	(cd $(dir $<); pdflatex $(notdir $<); cd ..)



# Run after building with cabal
install: # $(HASKELL_BUILD_DIR)/nemo-server/nemo-server
	install $(HASKELL_BUILD_DIR)/nemo-server/nemo-server /usr/local/bin

.PHONY: tags
tags:
	xargs --arg-file=taggable hasktags --ctags --append
	#xargs --arg-file=taggable ghc -e :ctags --fno-warn-missing-modules
	#find -iname '*.hs' -or -iname '*.hsc' | xargs hasktags
	#find src -iname '*.hs' -or -iname '*.hsc' | xargs ghc -e :ctags
	#ghc -e :ctags --make src/NSim.hs



.PHONY: count
count: cuda_count
	@echo "Lines of haskell source code: "
	@find src -iname '*.hs' -or -iname '*.hsc' | xargs cat | grep -v -e '^[[:space:]]*$$' -e '^[[:space:]]*--' -e '^ - ' -e '^{- ' | wc -l
	@echo "Lines of test code: "
	@find testsuite/Test -iname '*.hs' -or -iname '*.hsc' | xargs cat | grep -v -e '^[[:space:]]*$$' -e '^[[:space:]]*--' -e '^ - ' -e '^{- ' | wc -l


# The CUDA lib is built in cabals build tree, so it will be cleaned out along
# with all the haskell files.
.PHONY: clean
clean:
	./Setup.lhs clean
